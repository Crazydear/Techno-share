## 0.树莓派4B接口介绍 ##

### 树莓派4的GPIO接口 ###

![树莓派4的接口定义](images/raspberry4-GPIO-pinout-575x600.png)

### 通用输入/输出接口 GPIO ###

通用输入/输出就是GPIO的意思，GPIO很形象地描述了树莓派上这些接口的工作方式，它们类似于Arduino 数字或模拟端口，因为我们可以将它们配置为读或写。通过这些接口，可以让树莓派和不同的模块组件进行交互，比如按钮、电位器或者蜂鸣器等。

![树莓派4 GPIO BCM接口定义](images/raspberry-pi-pinout-800x249.png)

在实际使用中，我们应该熟悉树莓派接口的两种命名方案:1.WiringPi 编号、BCM编号、物理编号（Physical – Number）。WiringPi 编号是功能接线的引脚号（如TXD、PWM0等等）；BCM编号是 Broadcom 针脚号，也即是通常称的GPIO；物理编号是PCB板上针脚的物理位置对应的编号（1~40）。

### 电源和接地 ###

电源和接地引脚用于外部电路供电。所有版本标准40针 GPIO版本的树莓派都有两个5V引脚和两个3.3V引脚，而且均在同一个物理位置。除了5V和3.3V引脚外，它们还有8个接地引脚。电源和接地脚可以让你的树莓派为一些外部元件供电，如LED。需要注意的是，通过这些引脚为任何外部模块或元器件供电之前，应该保持谨慎，过大的工作电流或峰值电压均有可能损坏树莓派。

### 其它接口功能 ###

在实际使用中，许多项目还需要一些不同的功能。因此树莓派的一些GPIO引脚具有I2C、SPI和UART接口等双重功能，与树莓派3B+相比，树莓派4 支持这些功能的接口增加了，使许多引脚的功能得到了扩展。下面是对每种功能做一下简要的描述。

#### I2C接口 ####

I2C是由Philips公司开发的一种简单、双向二线制同步串行总线。它只需要两根线即可在连接于总线上的器件之间传送信息。树莓派通过I2C接口可控制多个传感器和组件。它们的通信是通过SDA(数据引脚)和SCL(时钟速度引脚)来完成的。每个从设备都有一个唯一的地址，允许与许多设备间快速通信。ID_EEPROM引脚也是I2C协议，它用于与HATs通信。

#### SPI接口 ####

SPI是串行外设接口，用于控制具有主从关系的组件，采用从进主出和主进从出的方式工作，树莓派上SPI由SCLK、MOSI、MISO接口组成，SCLK用于控制数据速度，MOSI将数据从树莓派发送到所连接的设备，而MISO则相反。

#### UART接口 ####

有使用Arduino的朋友一定听说过UART或Serial，通用异步收/发器接口用于将Arduino连接到为其编程的计算机上，也用于其他设备与 RX 和 TX 引脚之间的通信。如果树莓派在 raspi-config 中启用了串口终端，则可以使用这些引脚通过电脑来控制树莓派，也可以直接用于控制Arduino。

#### PWM接口 ####

在树莓派上，所有的引脚都可以实现软件PWM，而GPIO12、GPIO13、GPIO18、GPIO19可以实现硬件脉宽调制。关于PWM可阅读 [什么是PWM](https://www.basemu.com/what-is-pwm.html) 这篇文章。

##### 本章 [参考链接](https://www.basemu.com/raspberry-pi-4-gpio-pinout.html) #####

## 1.更新EEPROM并使用USB启动 ##

#### 1.1 先下载最新的EEPROM固件 ####

[Github地址](https://github.com/raspberrypi/rpi-eeprom/releases) 优先下载稳定版，截止2020-07-19稳定版为6-15版的，

> 对USB-MSD的更新-稳定
>
> 2020-06-15版本从提升`beta`为`stable`。`stable`发行流中的固件仅针对主要错误修复进行更新，新功能`beta`将首先在发行版中开发。
>
> - 在进行更多互操作测试之后，将默认关闭电源延迟时间增加到500ms。
> - 可通过USB_MSD_PWR_OFF_TIME配置来配置USB端口的关机时间。范围可以设置为250至1000ms。零表示没有端口断电。
> - 修复了XHCI端点配置中的一些错误，该错误是代码错误的，但对于当前的VL805 FW不会失败。

#### 1.2 将内存卡格式化 ####

#### 1.3 将下载下来的压缩包里的文件直接解压到内存卡根目录 ####

#### 1.4 将内存卡插上树莓派，等待15s以上，EEPROM升级成功 ####

绿灯会一直闪，接上显示屏会绿屏

#### 1.5 完成 ####

直接可以用做好的U盘启动系统了

## 2.风扇控制 ##

元件：三极管S8550，5V风扇，杜邦线

![image-20200717152324866](images/image-20200717152324866.png)

程序：

```python
#!/usr/bin python3
# -*- coding:utf-8 -*-
# Author:李绍丰 河北工业大学-能源与环境工程学院

# ****************************************************************
# 程序功能：风扇控制
# 模块划分：开启风扇，关闭风扇，获取CPU温度
# ****************************************************************

import RPi.GPIO as GPIO
import time

fan_pin = 14
GPIO.setwarnings(False)
GPIO.setmode(GPIO.BCM)
GPIO.setup(fan_pin,GPIO.OUT)

def on_fan():
    GPIO.output(fan_pin,False)

def off_fan():
    GPIO.output(fan_pin,True)

def get_CPU_temp():
    with open(r"/sys/class/thermal/thermal_zone0/temp") as file:
        temp = float(file.read()) / 1000
    return temp

# on_fan()
off_fan()
while True:
    temp = get_CPU_temp()
    if temp > 55:
        on_fan()
    if temp < 38:
        off_fan()
    time.sleep(30)
```

bash

```bash
#!/bin/bash

if [ -e /sys/class/gpio/gpio14/direction ]
then
echo "已经挂载"
else
echo "未挂载"
echo 14 > /sys/class/gpio/export
echo out > /sys/class/gpio/gpio14/direction
echo 1 > /sys/class/gpio/gpio14/value
fi


tem=$(cat /sys/class/thermal/thermal_zone0/temp)
echo $tem

if [ $tem -ge 65000 ]
then
echo out > /sys/class/gpio/gpio14/direction
fi

if [ $tem -le 40000 ]
then
echo 1 > /sys/class/gpio/gpio14/value 
echo 14 >/sys/class/gpio/unexport
echo "温度不高，已经unexport"
fi
```

cron：（每隔1分钟执行一次）

```bash
*/1 * * * * sudo bash /home/pi/python/fan.sh
```

成品图：

![image-20200717154121027](images/image-20200717154121027.png)

## 3.温度测量及阿里iot ##

元件：DHT11，杜邦线

说明：DHT11的误差在2℃左右，虽然有小数位，但是没启用

开通阿里云物联网产品服务。

阿里云物联网平台定义产品、设备：

登陆阿里云物联网平台>设备管理>产品中创建产品信息如下图

![img](images/2.1.jpeg)

产品功能定义>添加自定义功能：

![img](images/3.2.jpeg)

导出物模型JSON文件保存为dht11model.json供后面程序中使用

创建完产品后选择产品>管理设备 中添加设备

![img](images/3.3.jpeg)

依赖包:

```bash
pip install Adafruit-DHT  			# pip3 install Adafruit-DHT
pip install aliyun-iot-linkkit		# pip3 install aliyun-iot-linkkit
```

程序：

```python
#encoding:utf-8
import sys
import Adafruit_DHT
from linkkit import linkkit
import time
import logging
# config log
__log_format = '%(asctime)s-%(process)d-%(thread)d - %(name)s:%(module)s:%(funcName)s - %(levelname)s - %(message)s'
logging.basicConfig(format=__log_format)
# define DHT
DHT_SENSOR = Adafruit_DHT.DHT11
DHT_PIN = 12
#aliyun IoT python linkkit init
lk = linkkit.LinkKit(
    host_name="cn-shanghai",
    product_key="product_key_xxxx",
    device_name="device_name_dht11_pi",
    device_secret="device_secret_xxxxxxx")
lk.enable_logger(logging.DEBUG)
def on_device_dynamic_register(rc, value, userdata):
    if rc == 0:
        print("dynamic register device success, value:" + value)
    else:
        print("dynamic register device fail, message:" + value)

def on_connect(session_flag, rc, userdata):
    print("on_connect:%d,rc:%d" % (session_flag, rc)) 
    pass

def on_disconnect(rc, userdata):
    print("on_disconnect:rc:%d,userdata:" % rc)

def on_topic_message(topic, payload, qos, userdata):
    print("on_topic_message:" + topic + " payload:" + str(payload) + " qos:" + str(qos))
    pass

def on_subscribe_topic(mid, granted_qos, userdata): 
    print("on_subscribe_topic mid:%d, granted_qos:%s" %
          (mid, str(','.join('%s' % it for it in granted_qos)))) 
    pass

def on_unsubscribe_topic(mid, userdata):
    print("on_unsubscribe_topic mid:%d" % mid)
    pass

def on_publish_topic(mid, userdata): 
    print("on_publish_topic mid:%d" % mid)

lk.on_device_dynamic_register = on_device_dynamic_register
lk.on_connect = on_connect
lk.on_disconnect = on_disconnect
lk.on_topic_message = on_topic_message
lk.on_subscribe_topic = on_subscribe_topic
lk.on_unsubscribe_topic = on_unsubscribe_topic
lk.on_publish_topic = on_publish_topic

# thing setup
lk.thing_setup("/home/pi/python/dht/dht11model.json")
lk.connect_async()lk.start_worker_loop()time.sleep(10)

# start DHT sensor
while True:
    humidity, temperature = Adafruit_DHT.read(DHT_SENSOR, DHT_PIN)
    if humidity is not None and temperature is not None:
        print("Temp={0:0.1f}C Humidity={1:0.1f}%".format(temperature, humidity))
        prop_data={
            "Temp": temperature, 
            "Humidity": humidity 
        } 
        rc, request_id = lk.thing_post_property(prop_data)
        if rc == 0:
            print("thing_post_property topics success:%r, request_id:%r" % (1, request_id))
            time.sleep(300)
	else: 
        print("Sensor failure. Check wiring.")
        time.sleep(10)
```